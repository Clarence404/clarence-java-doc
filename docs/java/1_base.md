# Java åŸºç¡€

- APIåœ°å€ï¼š[https://docs.oracle.com/en/java/javase/](https://docs.oracle.com/en/java/javase/)
- æºç åœ°å€ï¼š[https://github.com/openjdk](https://github.com/openjdk)

## ä¸€ã€Hashmapåˆ†æ

HashMap æ˜¯ä¸€ç§åŸºäºå“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼Œå®ƒå®ç°äº† Map æ¥å£ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ (key-value)ã€‚å…¶åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š

### 1ã€å“ˆå¸Œè¡¨ï¼ˆHash Tableï¼‰

HashMap æ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„ï¼Œå“ˆå¸Œè¡¨çš„åŸºæœ¬æ€æƒ³æ˜¯é€šè¿‡å°†æ•°æ®çš„é”®å€¼å¯¹æ˜ å°„åˆ°ä¸€ä¸ªæ•°ç»„çš„ç´¢å¼•ä½ç½®ä¸Šæ¥æé«˜æ•°æ®æŸ¥æ‰¾çš„æ•ˆç‡ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

- **å“ˆå¸Œå‡½æ•°**ï¼š HashMap ä½¿ç”¨å“ˆå¸Œå‡½æ•°å°†é”®ï¼ˆkeyï¼‰æ˜ å°„åˆ°æ•°ç»„çš„ç´¢å¼•ä½ç½®ã€‚å“ˆå¸Œå‡½æ•°çš„ç›®çš„æ˜¯é€šè¿‡è®¡ç®—ä¸€ä¸ªå€¼ï¼Œå°†ä¸åŒçš„é”®æ˜ å°„åˆ°å“ˆå¸Œè¡¨ä¸­çš„ä½ç½®ã€‚

- **æ•°ç»„**ï¼š å“ˆå¸Œè¡¨å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨æ•°æ®ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å­˜å‚¨ä¸€ä¸ªé“¾è¡¨ï¼ˆæˆ–è€…åœ¨ Java 8 åæ˜¯
  <RouteLink to="/algorithm/0_base_4_tree#çº¢é»‘æ ‘-balanced-binary-search-tree-bbst">çº¢é»‘æ ‘</RouteLink>ï¼‰ï¼Œç”¨äºå¤„ç†å“ˆå¸Œå†²çªã€‚

### 2ã€å“ˆå¸Œå†²çª

ç”±äºå“ˆå¸Œå‡½æ•°ä¸å¯èƒ½åšåˆ°å®Œå…¨å”¯ä¸€çš„æ˜ å°„ï¼Œä¸åŒçš„é”®å¯èƒ½ä¼šè¢«æ˜ å°„åˆ°ç›¸åŒçš„ç´¢å¼•ï¼Œè¿™ç§æƒ…å†µç§°ä¸ºå“ˆå¸Œå†²çªã€‚HashMap é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³å“ˆå¸Œå†²çªï¼š

- **é“¾è¡¨æ³•ï¼ˆé“¾å¼å“ˆå¸Œï¼‰**ï¼š åœ¨å‘ç”Ÿå†²çªçš„æƒ…å†µä¸‹ï¼ŒHashMap ä¼šå°†å†²çªçš„é”®å€¼å¯¹å­˜å‚¨åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­
  ï¼ˆæˆ–è€… <RouteLink to="/algorithm/0_base_4_tree#çº¢é»‘æ ‘-balanced-binary-search-tree-bbst">çº¢é»‘æ ‘</RouteLink>ï¼‰ã€‚
  å½“å¤šä¸ªå…ƒç´ æ˜ å°„åˆ°åŒä¸€ä¸ªç´¢å¼•ä½ç½®æ—¶ï¼Œå®ƒä»¬ä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚

- **<RouteLink to="/algorithm/0_base_4_tree#çº¢é»‘æ ‘-balanced-binary-search-tree-bbst">çº¢é»‘æ ‘</RouteLink> æ³•**ï¼š åœ¨ Java 8
  åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœé“¾è¡¨çš„é•¿åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰ï¼ŒHashMap
  ä¼šå°†é“¾è¡¨è½¬åŒ–ä¸º <RouteLink to="/algorithm/0_base_4_tree#çº¢é»‘æ ‘-balanced-binary-search-tree-bbst">çº¢é»‘æ ‘</RouteLink>ï¼Œ
  ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚

![img.png](../assets/java/hashmap_hash_conflict.png)

### 3ã€æ‰©å®¹æœºåˆ¶

å½“ HashMap ä¸­çš„å…ƒç´ è¿‡å¤šæ—¶ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼ˆload factorï¼‰å¯èƒ½ä¼šè¾¾åˆ°é˜ˆå€¼ï¼Œå¯¼è‡´å“ˆå¸Œè¡¨çš„å­˜å‚¨æ•ˆç‡é™ä½ã€‚

- é»˜è®¤æƒ…å†µä¸‹ï¼Œè´Ÿè½½å› å­ä¸º 0.75ã€‚**å½“å…ƒç´ ä¸ªæ•°è¶…è¿‡ (å½“å‰å®¹é‡ * è´Ÿè½½å› å­) æ—¶ï¼ŒHashMap ä¼šè¿›è¡Œæ‰©å®¹ï¼ˆé€šå¸¸æ˜¯åŸæ•°ç»„å¤§å°çš„ 2 å€ï¼‰**ã€‚

- æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰å…ƒç´ çš„å“ˆå¸Œå€¼ä¼šè¢«é‡æ–°è®¡ç®—ï¼Œå¹¶é‡æ–°æ”¾ç½®åˆ°æ–°çš„æ•°ç»„ä½ç½®ã€‚å› ä¸º**å“ˆå¸Œè¡¨çš„å¤§å°å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´åŸå…ˆçš„ç´¢å¼•ä½ç½®ä¸å†é€‚ç”¨**ã€‚

### 4ã€æ—¶é—´å¤æ‚åº¦

- **æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ æ—¶é—´å¤æ‚åº¦**ï¼š

åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå“ˆå¸Œè¡¨çš„æŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚

ä½†æ˜¯ï¼Œå¦‚æœå‘ç”Ÿå“ˆå¸Œå†²çªï¼Œæ€§èƒ½ä¼šé€€åŒ–åˆ° O(n)ï¼ˆé“¾è¡¨é•¿åº¦ä¸º n æ—¶ï¼‰ã€‚
ä½¿ç”¨ <RouteLink to="/algorithm/0_base_4_tree#çº¢é»‘æ ‘-balanced-binary-search-tree-bbst">çº¢é»‘æ ‘</RouteLink>ä¼˜åŒ–åï¼Œæœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦ä¸º
O(log n)ã€‚

- **æ‰©å®¹æ“ä½œçš„æ—¶é—´å¤æ‚åº¦**ï¼š

æ‰©å®¹æ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼Œä½†æ‰©å®¹æ“ä½œæ˜¯æŒ‰éœ€è¿›è¡Œçš„ï¼Œä¸æ˜¯é¢‘ç¹å‘ç”Ÿï¼Œå› æ­¤å¹³å‡è€Œè¨€ï¼ŒHashMap çš„æ“ä½œä»ç„¶æ˜¯ O(1)ã€‚

## äºŒã€LinkedHashMapåˆ†æ

### 1ã€æœ‰åºæ€§æ”¯æŒ

ä¸ `HashMap` ä¸åŒï¼Œ`LinkedHashMap` ä¿ç•™äº†å…ƒç´ çš„é¡ºåºç‰¹æ€§ï¼š

- é»˜è®¤æŒ‰ç…§ **æ’å…¥é¡ºåº** æ’åˆ—ã€‚
- å¯ä»¥é€‰æ‹©æŒ‰ç…§ **è®¿é—®é¡ºåº** æ’åˆ—ï¼ˆæ„é€ å‡½æ•°ä¸­è®¾ç½® `accessOrder=true`ï¼‰ã€‚

### 2ã€éå†é¡ºåºå¯æ§

ä½¿ç”¨ `Iterator` éå†æ—¶ï¼Œå…ƒç´ çš„é¡ºåºï¼š

- æ’å…¥é¡ºåºæ¨¡å¼ä¸‹ï¼šä¸æ’å…¥é¡ºåºä¸€è‡´ï¼›
- è®¿é—®é¡ºåºæ¨¡å¼ä¸‹ï¼šæœ€è¿‘è¢«è®¿é—®çš„å…ƒç´ ä¼šæ’åœ¨åé¢ã€‚

### 3ã€åº”ç”¨åœºæ™¯ï¼šLRU ç¼“å­˜

é€šè¿‡è®¾ç½®ä¸ºè®¿é—®é¡ºåº + æ­é… `removeEldestEntry` æ–¹æ³•ï¼Œ`LinkedHashMap` å¯è½»æ¾å®ç°ï¼š

* **æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼‰ç¼“å­˜æ·˜æ±°ç­–ç•¥**

```java
new LinkedHashMap<>(16,0.75f,true) // accessOrder = true
```

### 4ã€ç±»å…³ç³»å›¾

![](../assets/java/LinkedHashMap.png)

## ä¸‰ã€ConcurrentHashMapåˆ†æ

### 1ã€åŸºæœ¬ç‰¹æ€§

| **ç‰¹æ€§**	             | **æè¿°**                                                                                      |
|---------------------|---------------------------------------------------------------------------------------------|
| **çº¿ç¨‹å®‰å…¨**            | 	é‡‡ç”¨ CAS + è‡ªæ—‹é” æ›¿ä»£ synchronizedï¼Œå‡å°‘é”ç«äº‰                                                         |
| **é«˜å¹¶å‘**	            | è¯»æ“ä½œæ— é”ï¼Œå†™æ“ä½œå±€éƒ¨åŠ é”ï¼Œé¿å…å…¨å±€é”çš„æ€§èƒ½ç“¶é¢ˆ                                                                    |
| **ä¸æ”¯æŒ null**        | 	key å’Œ value éƒ½ ä¸èƒ½ä¸º nullï¼Œé˜²æ­¢ NullPointerException                                             |
| **æ¯” Hashtable æ€§èƒ½é«˜** | 	Hashtable ä½¿ç”¨ synchronized è¿›è¡Œå…¨è¡¨åŠ é”ï¼Œè€Œ ConcurrentHashMap é‡‡ç”¨ åˆ†æ®µé”æœºåˆ¶ï¼ˆJDK 1.7ï¼‰å’Œ CAS + è‡ªæ—‹é”ï¼ˆJDK 1.8ï¼‰ |

### 2ã€JDK 1.7 å’Œ 1.8 å¯¹æ¯”

| **ç‰ˆæœ¬**	    | **JDK 1.7**	                   | **JDK 1.8 åŠä»¥å**              |
|------------|--------------------------------|------------------------------|
| **åº•å±‚æ•°æ®ç»“æ„** | 	Segmentï¼ˆåˆ†æ®µé”ï¼‰ + æ•°ç»„ + é“¾è¡¨        | 	æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ï¼ˆå¤§äº 8 ä¸ªå…ƒç´ ï¼‰     |
| **åŠ é”æ–¹å¼**	  | åˆ†æ®µé”ï¼ˆSegment ç»§æ‰¿ ReentrantLockï¼‰	 | CAS + è‡ªæ—‹é” + synchronizedï¼ˆå±€éƒ¨ï¼‰ |
| **å¹¶å‘æ§åˆ¶**	  | å¤šä¸ª Segment äº’ä¸å½±å“                | 	CAS æ–¹å¼ä¼˜åŒ–ï¼Œå‡å°‘é”ç«äº‰              |
| **å†™å…¥æ€§èƒ½**	  | åˆ†æ®µé”ï¼Œæ€§èƒ½è¾ƒå¥½                       | 	CAS + å±€éƒ¨é”ï¼Œæ€§èƒ½æ›´é«˜              |
| **æ‰©å®¹æœºåˆ¶**	  | Segment çº§åˆ«æ‰©å®¹	                  | æ— é”æ‰©å®¹ï¼Œæ”¯æŒå¹¶å‘æ‰©å®¹                  |

::: warning Todo
æ›´åŠ ç²¾é€šåå®Œæˆã€‚ã€‚ã€‚
:::

## å››ã€ConcurrentHashMap ä¸ºä½•æ”¾å¼ƒåˆ†æ®µé”ï¼Ÿ

### 1ã€JDK 1.7 å‰åˆ†æ®µé”å¼Šç«¯

åœ¨ JDK 1.7 ä¹‹å‰ï¼Œ`ConcurrentHashMap` ä½¿ç”¨ **åˆ†æ®µé”ï¼ˆSegmentï¼‰**ï¼Œæ¯ä¸ª `Segment` ç®¡ç†ç‹¬ç«‹çš„ `HashEntry[]`ã€‚ä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

- **æ‰©å®¹æ€§èƒ½å·®**ï¼šæ‰©å®¹æ—¶éœ€è¦å¯¹æ•´ä¸ª `Segment` åŠ é”ï¼Œå½±å“å¹¶å‘ã€‚

- **å†…å­˜æµªè´¹**ï¼šé¢„å…ˆåˆ†é…å¤šä¸ª `Segment`ï¼Œå³ä½¿ä¸ä½¿ç”¨ä¹Ÿå ç”¨å†…å­˜ã€‚

- **ä»£ç å¤æ‚**ï¼šé”ç®¡ç†å¤æ‚ï¼Œä¸” `put()` éœ€è¦ä¸¤æ¬¡ `hash` è®¡ç®—ï¼Œé™ä½æ€§èƒ½ã€‚

### 2ã€JDK 1.8 åçš„æ–°æ–¹æ¡ˆ

JDK 1.8 æ”¾å¼ƒäº† `Segment`ï¼Œæ”¹ç”¨ **æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘** ç»“æ„ï¼Œç»“åˆ **CAS** å’Œ **synchronized** å±€éƒ¨åŠ é”ï¼Œæå‡å¹¶å‘æ€§èƒ½ã€‚

- **CAS æ— é”ä¼˜åŒ–**ï¼šé¿å…é”ç«äº‰ï¼Œæé«˜ååé‡ã€‚

```java
public V put(K key, V value) {
    // æ‰°åŠ¨å“ˆå¸Œï¼Œå‡å°‘ç¢°æ’
    int hash = spread(key.hashCode());
    // è®¡ç®—æ¡¶ç´¢å¼•
    int i = (table.length - 1) & hash;

    // å¦‚æœæ¡¶æ˜¯ç©ºçš„ï¼Œç›´æ¥ CAS æ’å…¥ï¼ˆæ— é”ï¼‰
    if (tabAt(table, i) == null) {
        if (casTabAt(table, i, null, new Node<>(hash, key, value, null))) {
            return null;
        }
    }

    // å¦åˆ™è¿›å…¥åŠ é”æµç¨‹
    synchronized (table[i]) {
        // é“¾è¡¨æ’å…¥æˆ–æ ‘å½¢æ’å…¥é€»è¾‘...
    }
    return null;
}

```

- **synchronized å±€éƒ¨åŠ é”**ï¼šåªé”å®šå½“å‰æ¡¶ä½ï¼Œå‡å°‘é”ç«äº‰ã€‚

```java
private void putVal(int hash, K key, V value) {
    int i = (n - 1) & hash;
    Node<K, V> f = tabAt(table, i);

    if (f == null) {
        if (casTabAt(table, i, null, new Node<>(hash, key, value, null))) {
            return;
        }
    } else {
        synchronized (f) { // å±€éƒ¨åŠ é”ï¼Œåªé”å®šå½“å‰æ¡¶ä½
            Node<K, V> e = f;
            while (e != null) {
                if (e.hash == hash && Objects.equals(e.key, key)) {
                    e.value = value; // è¦†ç›–å·²æœ‰ key çš„å€¼
                    return;
                }
                e = e.next;
            }
            // æ’å…¥æ–°èŠ‚ç‚¹
            f.next = new Node<>(hash, key, value, null);
        }
    }
}

```

- **çº¢é»‘æ ‘ä¼˜åŒ–**ï¼šå½“é“¾è¡¨é•¿åº¦è¶…è¿‡ 8ï¼Œè½¬ä¸ºçº¢é»‘æ ‘ï¼ŒæŸ¥è¯¢æ•ˆç‡æé«˜ã€‚

```java
private void putVal(int hash, K key, V value) {
    int i = (n - 1) & hash;
    Node<K, V> f = tabAt(table, i);

    if (f != null) {
        int binCount = 1;
        Node<K, V> e = f;
        while (e.next != null) {
            binCount++;
            e = e.next;
        }

        if (binCount >= TREEIFY_THRESHOLD) { // é»˜è®¤å€¼ä¸º8
            treeifyBin(table, i); // è½¬ä¸ºçº¢é»‘æ ‘ç»“æ„
        }
    }
}

```

- **æ— é”æ‰©å®¹**ï¼šå¤šä¸ªçº¿ç¨‹å¹¶è¡Œè¿ç§»æ•°æ®ï¼Œæå‡æ‰©å®¹æ•ˆç‡ã€‚

```java
private void resize() {
    Node<K, V>[] oldTab = table;
    int oldCap = oldTab.length;
    int newCap = oldCap << 1;
    Node<K, V>[] newTab = new Node[newCap];

    for (int i = 0; i < oldCap; ++i) {
        Node<K, V> e = oldTab[i];
        if (e != null) {
            transferNode(e, newTab); // å°†é“¾è¡¨æˆ–æ ‘è¿ç§»åˆ°æ–°è¡¨
        }
    }

    table = newTab;
}

```

### 3ã€ä¸¤å¥è¯æ€»ç»“å¯¹æ¯”

- JDK 1.7 åˆ†æ®µé”çš„æ€§èƒ½å·®ã€ç©ºé—´æµªè´¹å’Œå¤æ‚æ€§é—®é¢˜ã€‚

- JDK 1.8 æ”¹ç”¨ CASã€synchronized å’Œçº¢é»‘æ ‘ï¼Œæå‡äº†å¹¶å‘æ€§èƒ½å’ŒæŸ¥è¯¢æ•ˆç‡ï¼Œæ”¯æŒæ— é”æ‰©å®¹ã€‚

> **æç¤º**ï¼šJDK 1.8 çš„ `ConcurrentHashMap` åœ¨é«˜å¹¶å‘ä¸‹è¡¨ç°æ›´ä¼˜ï¼Œé¿å…äº†åˆ†æ®µé”å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚

## å››ã€HashMapã€LinkedHashMapã€ConcurrentHashMapå¯¹æ¯”

| **å¯¹æ¯”é¡¹**             | **HashMap**      | **LinkedHashMap** | **ConcurrentHashMap** |
|---------------------|------------------|-------------------|-----------------------|
| **åº•å±‚æ•°æ®ç»“æ„**          | å“ˆå¸Œè¡¨ï¼ˆæ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘ï¼‰ | å“ˆå¸Œè¡¨ + åŒå‘é“¾è¡¨        | å“ˆå¸Œè¡¨ï¼ˆåˆ†æ®µé”ã€CAS æœºåˆ¶ï¼‰       |
| **key æ˜¯å¦æœ‰åº**        | âŒ æ— åº             | âœ… æŒ‰æ’å…¥é¡ºåºæ’åº         | âŒ æ— åº                  |
| **æ—¶é—´å¤æ‚åº¦**           | O(1) å¹³å‡ï¼ŒO(n) æœ€å  | O(1) å¹³å‡ï¼ŒO(n) æœ€å   | O(1) å¹³å‡ï¼ŒO(n) æœ€å       |
| **æ˜¯å¦å…è®¸ null key**   | âœ… å…è®¸             | âœ… å…è®¸              | âŒ ä¸å…è®¸                 |
| **æ˜¯å¦å…è®¸ null value** | âœ… å…è®¸             | âœ… å…è®¸              | âŒ ä¸å…è®¸                 |
| **çº¿ç¨‹å®‰å…¨**            | âŒ éçº¿ç¨‹å®‰å…¨          | âŒ éçº¿ç¨‹å®‰å…¨           | âœ… çº¿ç¨‹å®‰å…¨                |
| **é€‚ç”¨åœºæ™¯**            | å¿«é€ŸæŸ¥æ‰¾ã€æ— åºå­˜å‚¨ã€å¤§é‡æ•°æ®   | éœ€è¦æŒ‰æ’å…¥é¡ºåºéå†çš„åœºæ™¯      | å¹¶å‘ç¯å¢ƒä¸‹çš„é«˜æ•ˆå“ˆå¸Œæ˜ å°„          |
| **ä¸»è¦åº”ç”¨**            | ç¼“å­˜ã€æ˜ å°„æŸ¥æ‰¾ã€å¯¹è±¡å­˜å‚¨     | LRU ç¼“å­˜ã€è®¿é—®é¡ºåºå­˜å‚¨     | é«˜å¹¶å‘åœºæ™¯ï¼Œå¦‚ç¼“å­˜ã€çº¿ç¨‹æ±          |

## ä¸‰ã€TreeMapåˆ†æ

### 1ã€æºç åˆ†æ

- ç±»å…³è”å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](../assets/java/TreeMap.png)

- TreeMap çš„æ ¸å¿ƒç‰¹ç‚¹

| ç‰¹æ€§              | 	è¯´æ˜                                                                                                                              |
|-----------------|----------------------------------------------------------------------------------------------------------------------------------|
| åº•å±‚å®ç°            | 	 <RouteLink to="/algorithm/0_base_4_tree#çº¢é»‘æ ‘-balanced-binary-search-tree-bbst">çº¢é»‘æ ‘</RouteLink>ï¼ˆRed-Black Treeï¼‰ï¼Œæ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼ˆBSTï¼‰ |
| æ’åºæ–¹å¼            | 	é»˜è®¤æŒ‰ key çš„ è‡ªç„¶é¡ºåºï¼ˆComparableï¼‰ æ’åºï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ è‡ªå®šä¹‰ Comparator                                                                              |
| æ—¶é—´å¤æ‚åº¦           | 	O(log n)ï¼ˆå¢ã€åˆ ã€æŸ¥ï¼‰                                                                                                                 |
| æ˜¯å¦å…è®¸ null key   | 	âŒ ä¸å…è®¸ null keyï¼ˆä¼šæŠ› NullPointerExceptionï¼‰                                                                                         |
| æ˜¯å¦å…è®¸ null value | 	âœ… å…è®¸ null value                                                                                                                 |
| æ˜¯å¦çº¿ç¨‹å®‰å…¨          | 	âŒ éçº¿ç¨‹å®‰å…¨ï¼ˆéœ€è¦ Collections.synchronizedMap() ä¿æŠ¤ï¼‰                                                                                    |

::: important ä½¿ç”¨é€”å¾„
é€‚ç”¨äºéœ€è¦ "**è‡ªåŠ¨æ’åº**" å’Œ "**èŒƒå›´æŸ¥è¯¢**" çš„åœºæ™¯ã€‚
:::

1ã€é€‚ç”¨åœºæ™¯ï¼šæ•°æ®å­˜å‚¨æ—¶è¦æ±‚æŒ‰ç…§ key è¿›è¡Œæ’åºï¼Œæ–¹ä¾¿åç»­æŸ¥è¯¢å’Œå±•ç¤º

```java
private void test() {
    TreeMap<Integer, String> productMap = new TreeMap<>();
    productMap.put(102, "iPhone");
    productMap.put(101, "Samsung");
    productMap.put(103, "Huawei");

// éå†æ—¶ key æ˜¯æŒ‰é¡ºåºæ’åºçš„ï¼ˆ101, 102, 103ï¼‰
    for (Map.Entry<Integer, String> entry : productMap.entrySet()) {
        System.out.println(entry.getKey() + " -> " + entry.getValue());
    }
}
```

2ã€éœ€è¦ "èŒƒå›´æŸ¥è¯¢" æˆ– "åŒºé—´æœç´¢"

```java
private void test() {
    TreeMap<Long, String> transactionMap = new TreeMap<>();
    transactionMap.put(1707052800000L, "è®¢å• A");  // 2024-02-05 00:00:00
    transactionMap.put(1707139200000L, "è®¢å• B");  // 2024-02-06 00:00:00
    transactionMap.put(1707225600000L, "è®¢å• C");  // 2024-02-07 00:00:00

    // è·å– 2 æœˆ 5 æ—¥åˆ° 2 æœˆ 6 æ—¥ä¹‹é—´çš„äº¤æ˜“
    Map<Long, String> result = transactionMap.subMap(1707052800000L, 1707139200000L);
    System.out.println(result);
}
```

### 2ã€ç›¸å…³ç±»å¯¹æ¯”

| **å¯¹æ¯”é¡¹**             | **TreeMap**         | **ConcurrentSkipListMap** |
|---------------------|---------------------|---------------------------|
| **åº•å±‚æ•°æ®ç»“æ„**          | çº¢é»‘æ ‘ï¼ˆRed-Black Treeï¼‰ | è·³è¡¨ï¼ˆSkip Listï¼‰             |
| **key æ˜¯å¦æœ‰åº**        | âœ… æœ‰åºï¼ˆæŒ‰ key æ’åºï¼‰      | âœ… æœ‰åºï¼ˆæŒ‰ key æ’åºï¼‰            |
| **æ—¶é—´å¤æ‚åº¦**           | O(log n)            | O(log n)                  |
| **æ˜¯å¦å…è®¸ null key**   | âŒ ä¸å…è®¸               | âŒ ä¸å…è®¸                     |
| **æ˜¯å¦å…è®¸ null value** | âœ… å…è®¸                | âœ… å…è®¸                      |
| **çº¿ç¨‹å®‰å…¨**            | âŒ éçº¿ç¨‹å®‰å…¨             | âœ… çº¿ç¨‹å®‰å…¨                    |
| **é€‚ç”¨åœºæ™¯**            | éœ€è¦æ’åºã€èŒƒå›´æŸ¥è¯¢ã€å¯¼èˆªç»“æ„      | å¹¶å‘ç¯å¢ƒä¸‹çš„æœ‰åºæ˜ å°„                |
| **ä¸»è¦åº”ç”¨**            | æ’åã€æ—¥å¿—å­˜å‚¨ã€åŒºé—´æŸ¥æ‰¾        | çº¿ç¨‹å®‰å…¨çš„æ’åºæ˜ å°„ç»“æ„               |

## å››ã€HashMapå’ŒHashTableå¯¹æ¯”

### 1ã€ç»å…¸å¯¹æ¯”

| å¯¹æ¯”é¡¹	           | HashMap	                    | Hashtable                  |
|----------------|-----------------------------|----------------------------|
| **çº¿ç¨‹å®‰å…¨**	      | âŒ éçº¿ç¨‹å®‰å…¨                     | 	âœ… çº¿ç¨‹å®‰å…¨ï¼ˆæ–¹æ³•åŠ é” synchronizedï¼‰ |
| **æ€§èƒ½**	        | ğŸš€ æ€§èƒ½æ›´é«˜ï¼ˆæ— é”ï¼‰	                | ğŸŒ æ€§èƒ½è¾ƒä½ï¼ˆåŠ é”å¯¼è‡´å¼€é”€å¤§ï¼‰           |
| **æ˜¯å¦å…è®¸ null**	 | âœ… null key/value å…è®¸	        | âŒ null key/value ä¸å…è®¸       |
| **æ•°æ®ç»“æ„**       | 	JDK 1.8+: æ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘	     | æ•°ç»„ + é“¾è¡¨                    |
| **é»˜è®¤åˆå§‹å®¹é‡**     | 	16                         | 	11                        |
| **æ‰©å®¹æ–¹å¼**	      | å®¹é‡ç¿»å€ï¼ˆ2^n ç»“æ„ä¼˜åŒ–ï¼‰              | 	å®¹é‡ç¿»å€ + 1                  |
| **éå†æ–¹å¼**	      | è¿­ä»£å™¨ Iteratorï¼ˆfail-fast æœºåˆ¶ï¼‰	 | Enumerationï¼ˆæ—§ç‰ˆæ–¹å¼ï¼‰          |
| **é€‚ç”¨åœºæ™¯**	      | é€‚ç”¨äº å•çº¿ç¨‹ã€é«˜æ€§èƒ½åœºæ™¯	              | é€‚ç”¨äº å†å²é—ç•™ä»£ç ã€å¹¶å‘åœºæ™¯ï¼ˆå·²è¢«æ·˜æ±°ï¼‰      |

### 2ã€æ¨è ConcurrentHashMap

::: tip
âœ… ç”¨ HashMap

- å¤§å¤šæ•°åœºæ™¯ æ¨èä½¿ç”¨ HashMapï¼Œåªåœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚

âœ… ç”¨ ConcurrentHashMapï¼ˆä»£æ›¿ Hashtableï¼‰

- å¦‚æœéœ€è¦çº¿ç¨‹å®‰å…¨ï¼Œ**è¯·ç”¨ ConcurrentHashMapï¼Œä¸è¦ç”¨ Hashtableï¼**

- ConcurrentHashMap åœ¨ **é«˜å¹¶å‘ åœºæ™¯ä¸‹æ¯” Hashtable æ€§èƒ½æ›´ä¼˜ï¼ˆå±€éƒ¨åŠ é”ï¼Œç”šè‡³æ— é”ï¼‰**ã€‚

:::

## äº”ã€çº¿ç¨‹çš„åˆ›å»ºæ–¹å¼

### 1ã€ç»§æ‰¿ Thread ç±»

è¿™ç§æ–¹æ³•éœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„çº¿ç¨‹ç±»ï¼Œç»§æ‰¿ Thread ç±»ï¼Œå¹¶é‡å†™ run() æ–¹æ³•ã€‚

```java
class MyThread extends Thread {
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + ": Hello from thread!");
    }

    public static void main(String[] args) {
        MyThread thread = new MyThread();
        // å¯åŠ¨çº¿ç¨‹
        thread.start();
    }
}
```

- ä¼˜ç‚¹ï¼šç®€å•ç›´è§‚ï¼Œé€‚åˆåªæœ‰ä¸€ä¸ªä»»åŠ¡çš„æƒ…å†µã€‚

- ç¼ºç‚¹ï¼šå¦‚æœéœ€è¦ç»§æ‰¿å…¶ä»–ç±»ï¼Œæ— æ³•å†ç»§æ‰¿ Thread ç±»ï¼ˆJava æ˜¯å•ç»§æ‰¿ï¼‰ã€‚

### 2ã€å®ç° Runnable æ¥å£

è¿™ç§æ–¹æ³•æ›´çµæ´»ï¼Œåˆ›å»ºä¸€ä¸ªå®ç° Runnable æ¥å£çš„ç±»ï¼Œå¹¶å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™ Thread æ„é€ å‡½æ•°ã€‚

```java
class MyRunnable implements Runnable {
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + ": Hello from Runnable!");
    }

    public static void main(String[] args) {
        MyRunnable task = new MyRunnable();
        Thread thread = new Thread(task);  // å°†ä»»åŠ¡ä¼ é€’ç»™çº¿ç¨‹
        thread.start();  // å¯åŠ¨çº¿ç¨‹
    }
}
```

- ä¼˜ç‚¹ï¼šå…è®¸å®ç°å¤šä¸ªæ¥å£ï¼Œæä¾›æ›´å¤šçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

- ç¼ºç‚¹ï¼šæ¯”ç»§æ‰¿ Thread ç±»ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†é€šå¸¸æ›´åŠ æ¨èã€‚


### 3ã€å®ç° Callable æ¥å£ï¼ˆå¸¦è¿”å›å€¼çš„ä»»åŠ¡ï¼‰

`Callable` æ˜¯ Java 5 å¼•å…¥çš„åŠŸèƒ½æ€§æ¥å£ï¼Œä¸ `Runnable` ç±»ä¼¼ï¼Œç”¨äºå®šä¹‰çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡é€»è¾‘ã€‚ä½†å®ƒæ”¯æŒï¼š

- è¿”å›ç»“æœï¼›
- æŠ›å‡ºå¼‚å¸¸ã€‚

```java
import java.util.concurrent.Callable;

class MyCallable implements Callable<String> {
    @Override
    public String call() throws Exception {
        Thread.sleep(1000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        return "Hello from Callable";
    }
}
```

- ä¸ `Runnable` ä¸åŒï¼Œ`Callable` çš„ `call()` æ–¹æ³•æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”å¯ä»¥æŠ›å‡ºå—æ£€å¼‚å¸¸ã€‚
- é€šå¸¸ä¸ `Future`ã€`ExecutorService` æ­é…ä½¿ç”¨ã€‚

---

### 4ã€Future æ¥å£ï¼ˆä»»åŠ¡ç»“æœçš„è·å–ä¸æ§åˆ¶ï¼‰

`Future` ç”¨äºè¡¨ç¤º**ä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„ç»“æœ**ã€‚é€šè¿‡å®ƒå¯ä»¥ï¼š

* è·å– `Callable` ä»»åŠ¡çš„è¿”å›ç»“æœï¼›
* æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆï¼›
* å–æ¶ˆä»»åŠ¡ï¼›
* é˜»å¡ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚

#### ç¤ºä¾‹ï¼šç»“åˆ Callable å’Œ Future ä½¿ç”¨

```java
import java.util.concurrent.*;

public class FutureDemo {
    public static void main(String[] args) throws Exception {
        ExecutorService executor = Executors.newSingleThreadExecutor();

        Callable<String> task = () -> {
            Thread.sleep(1000);
            return "Callable task completed";
        };

        Future<String> future = executor.submit(task); // æäº¤ Callable ä»»åŠ¡

        // å¯ä»¥åšå…¶ä»–äº‹æƒ…
        System.out.println("Main thread doing other things...");

        // è·å–ç»“æœï¼ˆä¼šé˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆï¼‰
        String result = future.get();
        System.out.println("Task result: " + result);

        executor.shutdown();
    }
}
```

#### Future å¸¸ç”¨æ–¹æ³•

| æ–¹æ³•                   | æè¿°                                    |
| -------------------- | ------------------------------------- |
| `get()`              | é˜»å¡ç­‰å¾…ä»»åŠ¡å®Œæˆå¹¶è¿”å›ç»“æœã€‚                        |
| `get(timeout, unit)` | åœ¨æŒ‡å®šæ—¶é—´å†…ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œè¶…æ—¶æŠ›å‡º `TimeoutException`ã€‚ |
| `isDone()`           | åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²å®Œæˆã€‚                            |
| `cancel(true)`       | å°è¯•å–æ¶ˆä»»åŠ¡ï¼ˆå¦‚è®¾ç½®ä¸º trueï¼Œå¯ä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼‰ã€‚         |
| `isCancelled()`      | åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²è¢«å–æ¶ˆã€‚                           |

### 5ã€å…¶ä»–é«˜çº§æ–¹å¼

- <RouteLink to="/java/2_advanced.html#ä¸‰ã€å¤šçº¿ç¨‹ä¸å¹¶å‘ç¼–ç¨‹">å¤šçº¿ç¨‹ä¸å¹¶å‘ç¼–ç¨‹</RouteLink>

## å…­ã€volatile å…³é”®å­—

### 1ã€çº¿ç¨‹å¯è§æ€§æœºåˆ¶

#### **å†…å­˜æ¨¡å‹å›¾è§£**

![volatile.png](../assets/java/volatile.png)

#### **æ ¸å¿ƒç‰¹æ€§**

- **å³æ—¶åˆ·æ–°**ï¼šå½“çº¿ç¨‹ä¿®æ”¹volatileå˜é‡æ—¶ï¼Œæ–°å€¼**ç«‹å³å†™å›ä¸»å†…å­˜**

- **è¯»å–ç©¿é€**ï¼šå…¶ä»–çº¿ç¨‹è¯»å–æ—¶**ç»•è¿‡å·¥ä½œå†…å­˜**ï¼Œç›´æ¥è¯»å–ä¸»å†…å­˜æœ€æ–°å€¼

- **é€‚ç”¨åœºæ™¯**ï¼šçŠ¶æ€æ ‡å¿—ä½ï¼ˆå¦‚`boolean running`ï¼‰ã€ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ

> âš ï¸ æ³¨æ„ï¼š`count++`è¿™ç±»å¤åˆæ“ä½œä»éœ€é…åˆ`synchronized`æˆ–`AtomicXXX`

### 2ã€ç¦æ­¢æŒ‡ä»¤é‡æ’åŸç†

#### **å†…å­˜å±éšœç¤ºæ„å›¾**

![command_reformat.png](../assets/java/command_reformat.png)

#### **happens-beforeè§„åˆ™**

1. **å†™å±éšœ**ï¼šç¡®ä¿volatileå†™ä¹‹å‰çš„æ“ä½œä¸ä¼šé‡æ’åˆ°å†™ä¹‹å

2. **è¯»å±éšœ**ï¼šé˜²æ­¢volatileè¯»ä¹‹åçš„æ“ä½œé‡æ’åˆ°è¯»ä¹‹å‰

3. **ä¼ é€’æ€§**ï¼šçº¿ç¨‹Aå†™volatileå˜é‡ â†’ çº¿ç¨‹Bè¯»è¯¥å˜é‡ â†’ çº¿ç¨‹Bèƒ½çœ‹åˆ°Açš„æ‰€æœ‰å†™æ“ä½œ

### 3ã€åŒé‡æ£€æŸ¥é”æ¡ˆä¾‹

#### æ­£ç¡®å®ç°ä»£ç 

```java
private static volatile Singleton instance;

public static Singleton getInstance() {
    if (instance == null) {
        synchronized (Singleton.class) {
            if (instance == null) {
                // volatileä¿è¯ä»¥ä¸‹æ“ä½œä¸é‡æ’ï¼š
                // 1. memory = allocate() åˆ†é…ç©ºé—´
                // 2. init(memory) åˆå§‹åŒ–å¯¹è±¡ â† StoreStoreå±éšœåœ¨æ­¤
                // 3. instance = memory è®¾ç½®å¼•ç”¨ â† StoreLoadå±éšœåœ¨æ­¤
                instance = new Singleton();
            }
        }
    }
    return instance; // LoadLoadå±éšœä¿è¯è¯»åˆ°æœ€æ–°å€¼
}
```

#### **å¯¹è±¡åˆ›å»ºè¿‡ç¨‹å›¾è§£**

![singleton_double_check.png](../assets/java/singleton_double_check.png)

#### **å…³é”®ä½œç”¨**

- é˜»æ­¢`instance = new Singleton()`è¢«é‡æ’ä¸ºã€Œå…ˆèµ‹å€¼ååˆå§‹åŒ–ã€

- ä¿è¯å…¶ä»–çº¿ç¨‹æ‹¿åˆ°çš„æ˜¯**å®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡**

### 4ã€å¯¹æ¯”æ€»ç»“è¡¨

| ç‰¹æ€§   | volatile | synchronized | AtomicXXX |
|------|----------|--------------|-----------|
| å¯è§æ€§  | âœ”        | âœ”            | âœ”         |
| åŸå­æ€§  | âœ–        | âœ”            | âœ”         |
| ç¦æ­¢é‡æ’ | âœ”        | âœ”            | âœ–         |
| æ€§èƒ½æˆæœ¬ | ä½        | é«˜            | ä¸­         |

## ä¸ƒã€çº¿ç¨‹çš„ç­‰å¾…ä¸å”¤é†’æœºåˆ¶

åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œçº¿ç¨‹çš„ç­‰å¾…ä¸å”¤é†’æ˜¯å®ç°çº¿ç¨‹é—´åä½œã€èµ„æºåŒæ­¥çš„é‡è¦æ‰‹æ®µã€‚Java ä¸­æä¾›äº†å¤šç§æœºåˆ¶æ¥å®ç°çº¿ç¨‹çš„é˜»å¡ä¸å”¤é†’ï¼Œ
åŒ…æ‹¬åŸºäº `Object`ã€`Thread`ã€`Lock` ä»¥åŠ `LockSupport` çš„æ–¹å¼ã€‚

### 1ã€Objectçš„wait() / notify() / notifyAll()

- å±äºåŸºç¡€çš„çº¿ç¨‹é€šä¿¡æ–¹å¼ï¼Œä½¿ç”¨çš„æ˜¯å¯¹è±¡ç›‘è§†å™¨ï¼ˆMonitorï¼‰ã€‚

- åªèƒ½åœ¨ `synchronized` å—æˆ–æ–¹æ³•å†…éƒ¨è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ›å‡º `IllegalMonitorStateException`ã€‚

- æ–¹æ³•è¯´æ˜ï¼š

    - `wait()`ï¼šå½“å‰çº¿ç¨‹ç­‰å¾…å¹¶é‡Šæ”¾é”ï¼Œè¿›å…¥å¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—ã€‚

    - `notify()`ï¼šå”¤é†’ä¸€ä¸ªæ­£åœ¨ç­‰å¾…è¯¥å¯¹è±¡é”çš„çº¿ç¨‹ï¼ˆå…·ä½“å“ªä¸ªç”± JVM å†³å®šï¼‰ã€‚

    - `notifyAll()`ï¼šå”¤é†’æ‰€æœ‰ç­‰å¾…è¯¥å¯¹è±¡é”çš„çº¿ç¨‹ã€‚

```java
private void test() {
    synchronized (lock) {
        while (!condition) {
            lock.wait();
        }
        // do something
        lock.notify();
    }
}
```

### 2ã€Thread.sleep()

- ä½¿å½“å‰çº¿ç¨‹è¿›å…¥â€œç¡çœ çŠ¶æ€â€ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…ä¸å‚ä¸ CPU è°ƒåº¦ã€‚

- ä¸é”æ— å…³ï¼Œä¸é‡Šæ”¾ä»»ä½•å¯¹è±¡é”ã€‚

- å¸¸ç”¨äºé™æµã€è½®è¯¢ç­‰å¾…ç­‰åœºæ™¯ã€‚

```java
Thread.sleep(1000); // ä¼‘çœ 1ç§’
```

### 3ã€Lockçš„Condition.await() / signal() / signalAll()

- ä¸ `ReentrantLock` é…åˆä½¿ç”¨ï¼ŒåŠŸèƒ½ç±»ä¼¼ `wait/notify`ï¼Œä½†æ›´çµæ´»ã€‚

- ä¸€ä¸ª `Lock` å¯ä»¥åˆ›å»ºå¤šä¸ª `Condition`ï¼Œæ¯ä¸ªæ¡ä»¶å˜é‡ç»´æŠ¤ç‹¬ç«‹çš„ç­‰å¾…é˜Ÿåˆ—ã€‚

```java
private void test() {
    Lock lock = new ReentrantLock();
    Condition condition = lock.newCondition();

    lock.lock();
    try {
        while (!conditionSatisfied) {
            condition.await();  // ç­‰å¾…
        }
        // æ¡ä»¶æ»¡è¶³åæ‰§è¡Œé€»è¾‘
        condition.signal();     // å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹
    } finally {
        lock.unlock();
    }
}
```

### 4ã€LockSupport.park() / unpark()

- æ›´åº•å±‚çš„çº¿ç¨‹é˜»å¡ä¸å”¤é†’å·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºå¹¶å‘ç±»åº“ï¼ˆå¦‚ AQSï¼‰ã€‚

- ä¸ä¾èµ–é”æœºåˆ¶ï¼Œçº¿ç¨‹å¯éšæ—¶ `park()` æš‚åœè‡ªå·±ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ `unpark()` å”¤é†’ã€‚

- æ”¯æŒå…ˆ `unpark()` å `park()` çš„è°ƒç”¨é¡ºåºï¼Œä¸ä¼šä¸¢å¤±ä¿¡å·ã€‚

```java
private void test() {
    LockSupport.park();  // é˜»å¡å½“å‰çº¿ç¨‹
    LockSupport.unpark(thread);  // å”¤é†’æŒ‡å®šçº¿ç¨‹
}
```

### 5ã€å°ç»“å¯¹æ¯”

| æœºåˆ¶            | æ˜¯å¦é‡Šæ”¾é” | æ˜¯å¦ä¾èµ–é”           | å”¤é†’ç²’åº¦       | åº”ç”¨åœºæ™¯       |
|---------------|-------|-----------------|------------|------------|
| `wait/notify` | æ˜¯     | æ˜¯ï¼ˆsynchronizedï¼‰ | ä¸å¯æ§ï¼ˆJVMå†³å®šï¼‰ | çº¿ç¨‹åä½œï¼ˆç»å…¸ç”¨æ³•ï¼‰ |
| `sleep`       | å¦     | å¦               | æ— éœ€å”¤é†’       | å®šæ—¶ç­‰å¾…       |
| `Condition`   | æ˜¯     | æ˜¯ï¼ˆLockï¼‰         | å¯æ§ï¼ˆæ¡ä»¶å˜é‡ï¼‰   | ç²¾ç»†æ§åˆ¶å¹¶å‘     |
| `LockSupport` | å¦     | å¦               | ç²¾ç¡®ï¼ˆçº¿ç¨‹çº§ï¼‰    | é«˜çº§å¹¶å‘å·¥å…·å®ç°   |

## å…«ã€çº¿ç¨‹æ± åŸºç¡€ï¼ˆExecutorsï¼‰

### 1ã€Executorså·¥å…·ç±»

`Executors` æ˜¯ Java ä¸­ç”¨äºç®¡ç†çº¿ç¨‹æ± çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå®ƒæ˜¯ `java.util.concurrent` åŒ…çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡ `Executors`ï¼Œ
æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹æ± ï¼Œé¿å…æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæé«˜ç¨‹åºçš„æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

### 2ã€ `Executors` çš„åˆ›å»ºæ–¹å¼

```java
private void test() {
    //åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹æ± å¯ä»¥å®¹çº³å›ºå®šæ•°é‡çš„çº¿ç¨‹ã€‚å®ƒé€‚ç”¨äºè´Ÿè½½è¾ƒä¸ºç¨³å®šçš„åœºæ™¯ï¼Œçº¿ç¨‹æ•°å›ºå®šã€‚
    ExecutorService executor = Executors.newFixedThreadPool(5);

    //åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ã€‚è¯¥çº¿ç¨‹æ± ä¼šæ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹é•¿æ—¶é—´æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œå®ƒä¼šè¢«å›æ”¶ã€‚
    ExecutorService executor = Executors.newCachedThreadPool();

    //åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œæ‰€æœ‰ä»»åŠ¡ä¼šæŒ‰ç…§æäº¤çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚
    ExecutorService executor = Executors.newSingleThreadExecutor();

    //åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± ï¼Œæ”¯æŒä»»åŠ¡çš„å»¶è¿Ÿæ‰§è¡Œå’Œå®šæœŸæ‰§è¡Œã€‚
    ScheduledExecutorService executor = Executors.newScheduledThreadPool(5);

    //åˆ›å»ºä¸€ä¸ªå·¥ä½œçªƒå–çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± ä¼šè‡ªåŠ¨è°ƒæ•´çº¿ç¨‹çš„æ•°é‡ï¼Œé€‚ç”¨äºæœ‰å¤šä¸ªä»»åŠ¡éœ€è¦å¹¶å‘æ‰§è¡Œçš„åœºæ™¯ã€‚
    ExecutorService executor = Executors.newWorkStealingPool();
}
```

### 3ã€ `invokeAll()` å’Œ `invokeAny()`

è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äºæ‰§è¡Œä»»åŠ¡ï¼š

- **`invokeAll()`**ï¼šå°†ä¸€ç»„ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± å¹¶ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚è¿”å›ä¸€ä¸ª `List<Future>`ï¼Œè¡¨ç¤ºæ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚

```java
private void test() {
    List<Callable<Integer>> tasks = new ArrayList<>();
    tasks.add(() -> {
        return 1;
    });
    tasks.add(() -> {
        return 2;
    });
    List<Future<Integer>> results = executor.invokeAll(tasks);
}
  ```

- **`invokeAny()`**ï¼šå°†ä¸€ç»„ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± ï¼Œå¹¶ç­‰å¾…å…¶ä¸­ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆã€‚è¿”å›ç¬¬ä¸€ä¸ªå®Œæˆä»»åŠ¡çš„ç»“æœã€‚

```java
Integer result = executor.invokeAny(tasks);
```

### 4ã€ä½¿ç”¨ `Future` å’Œ `Callable`

å½“éœ€è¦è·å–ä»»åŠ¡æ‰§è¡Œç»“æœæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨ `Future` å’Œ `Callable`ï¼š

- **`Future`**ï¼šè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥è®¡ç®—çš„ç»“æœï¼Œå¯ä»¥é€šè¿‡ `get()` æ–¹æ³•è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚
- **`Callable`**ï¼šç±»ä¼¼äº `Runnable`ï¼Œä½†æ˜¯å¯ä»¥è¿”å›ç»“æœï¼Œå¹¶ä¸”å¯ä»¥æŠ›å‡ºå¼‚å¸¸ã€‚

```java
private void test() {
    ExecutorService executor = Executors.newFixedThreadPool(2);

    Callable<Integer> task = () -> {
        // æ‰§è¡Œä»»åŠ¡
        return 1 + 1;
    };

    Future<Integer> future = executor.submit(task);
    Integer result = future.get(); // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ
}
```

### 5ã€Executors æ€»ç»“

`Executors` ç±»æä¾›äº†å¤šç§ç±»å‹çš„çº¿ç¨‹æ± ï¼Œå¯ä»¥æ ¹æ®ä»»åŠ¡çš„éœ€æ±‚é€‰æ‹©ä¸åŒç±»å‹çš„çº¿ç¨‹æ± ã€‚åˆç†ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥æé«˜å¹¶å‘ç¨‹åºçš„æ€§èƒ½ï¼Œ
å¹¶ä¸”é¿å…äº†æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„å¤æ‚æ€§ï¼Œé¿å…äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ã€‚

### 6ã€ä¸ºä½•ä¸å»ºè®® Executorsï¼Ÿ

**Executors** è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹:

- **FixedThreadPool** å’Œ **SingleThreadPool**: å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—ï¼ˆ**LinkedBlockingQueue**ï¼‰é•¿åº¦ä¸º **Integer.MAX VALUE**
  ï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

- **CachedThreadPool**: å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º **LinkedBlockingQueue**ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

ç»¼ä¸Šï¼Œä¸ºäº†æ‰‹åŠ¨æ§åˆ¶çº¿ç¨‹æ± ï¼Œå»ºè®®è‡ªå·±ä½¿ç”¨ <RouteLink to="/high-concurrency/1_thread_pool.html">ThreadPoolExecutor</RouteLink> æ¥åˆ›å»ºçº¿ç¨‹æ± 

## ä¹ã€ThreadLocal

### 1ã€åŸºç¡€æ¦‚å¿µ

`ThreadLocal` æ˜¯ Java ä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ä¸€ä¸ª **ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬**ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¯¥å˜é‡çš„ä¸€ä¸ªç‹¬ç«‹å‰¯æœ¬ï¼Œå› æ­¤ä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„å‰¯æœ¬ã€‚

#### **ç‰¹ç‚¹ï¼š**

- æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæŒæœ‰è‡ªå·±ç‹¬ç«‹çš„ **ThreadLocal å˜é‡å‰¯æœ¬**ã€‚

- çº¿ç¨‹ä¹‹é—´çš„å˜é‡æ˜¯éš”ç¦»çš„ï¼Œä¸ä¼šç›¸äº’å½±å“ã€‚

- é€šå¸¸ç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä¿å­˜çº¿ç¨‹çº§åˆ«çš„å±€éƒ¨å˜é‡ï¼Œä¾‹å¦‚æ•°æ®åº“è¿æ¥ã€ç”¨æˆ·ä¼šè¯ç­‰ã€‚

- çº¿ç¨‹ç»“æŸæ—¶ï¼Œç›¸å…³èµ„æºï¼ˆå¦‚å†…å­˜ï¼‰å¯ä»¥è¢«æ¸…ç†ã€‚

### 2ã€åº•å±‚åŸç†

![img_5.png](../assets/java/threadlocal_usage.png)

### 3ã€å†…éƒ¨ç»“æ„

![img_5.png](../assets/java/threadlocal_structure.png)

### 4ã€ç¤ºä¾‹ä»£ç 

```java
public class ThreadLocalExample {
    private static ThreadLocal<Integer> threadLocalValue = ThreadLocal.withInitial(() -> 0);

    public static void main(String[] args) {
        // æ¨¡æ‹Ÿå¤šçº¿ç¨‹ç¯å¢ƒ
        Runnable task = () -> {
            int value = threadLocalValue.get();
            System.out.println(Thread.currentThread().getName() + " initial value: " + value);
            threadLocalValue.set(value + 1); // ä¿®æ”¹è¯¥çº¿ç¨‹çš„å‰¯æœ¬
            System.out.println(Thread.currentThread().getName() + " modified value: " + threadLocalValue.get());
        };

        // å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹
        Thread t1 = new Thread(task);
        Thread t2 = new Thread(task);
        t1.start();
        t2.start();
    }
}
```

**è¾“å‡ºï¼š**

```
Thread-0 initial value: 0
Thread-1 initial value: 0
Thread-0 modified value: 1
Thread-1 modified value: 1
```

- çº¿ç¨‹ `Thread-0` å’Œ `Thread-1` æ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„ `ThreadLocal` å˜é‡å‰¯æœ¬ï¼Œäº’ä¸å¹²æ‰°ã€‚

### 5ã€é€‚ç”¨åœºæ™¯

- **çº¿ç¨‹å±€éƒ¨å˜é‡**ï¼šä¾‹å¦‚å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„è¿æ¥ä¿¡æ¯ã€æ—¥å¿—æ ‡è¯†ç¬¦ç­‰ã€‚

- **é¿å…ç«äº‰æ¡ä»¶**ï¼šé¿å…å¤šä¸ªçº¿ç¨‹å…±äº«å˜é‡æ—¶å¼•å‘çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

## åã€TransmittableThreadLocal

### 1ã€åŸºç¡€æ¦‚å¿µ

`TransmittableThreadLocal` æ˜¯ä¸€ç§åŸºäº `ThreadLocal` çš„å¢å¼ºç‰ˆæœ¬ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ `Alibaba` çš„ **Arthas** åº“ï¼‰æä¾›çš„ï¼Œå®ƒçš„ä¸»è¦
åŠŸèƒ½æ˜¯ **æ”¯æŒè·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼**ï¼Œç‰¹åˆ«æ˜¯åœ¨å¼‚æ­¥ä»»åŠ¡æˆ–çº¿ç¨‹æ± ä¸­ï¼Œ`ThreadLocal` çš„å€¼ä¼šè¢«ä¸¢å¤±ï¼Œå› ä¸ºçº¿ç¨‹æ± çš„çº¿ç¨‹æ˜¯å¤ç”¨çš„ã€‚

- ä¸ `ThreadLocal` ä¸åŒï¼Œ`TransmittableThreadLocal` æ”¯æŒ **è·¨çº¿ç¨‹ä¼ é€’å˜é‡**ï¼Œå³ä½¿æ˜¯çº¿ç¨‹æ± æˆ–å¼‚æ­¥æ‰§è¡Œçš„æƒ…å†µï¼Œä¹Ÿå¯ä»¥ä¼ é€’å˜é‡çš„å€¼ã€‚

- é€‚ç”¨äºçº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æˆ–å¼‚æ­¥æ“ä½œï¼Œå®ƒå¯ä»¥ **ç»§æ‰¿çˆ¶çº¿ç¨‹ä¸­çš„ `ThreadLocal` å€¼**ï¼Œå³ä½¿çº¿ç¨‹è¢«æ± å¤ç”¨ï¼Œå€¼ä¹Ÿèƒ½æ­£ç¡®ä¼ é€’åˆ°å­çº¿ç¨‹ã€‚

- çº¿ç¨‹æ± çš„å¤ç”¨ç‰¹æ€§ä¼šå¯¼è‡´ä¼ ç»Ÿ `ThreadLocal` çš„å€¼ä¸¢å¤±ï¼Œä½† `TransmittableThreadLocal` è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼Œèƒ½å¤Ÿä¼ é€’è¿™äº›å€¼ã€‚

### 2ã€ç¤ºä¾‹ä»£ç 

```java
import com.alibaba.ttl.TransmittableThreadLocal;

public class TransmittableThreadLocalExample {
    private static TransmittableThreadLocal<Integer> transmittableThreadLocalValue = new TransmittableThreadLocal<>();

    public static void main(String[] args) {
        transmittableThreadLocalValue.set(10);  // è®¾ç½®ä¸»çº¿ç¨‹ä¸­çš„å€¼

        // æ¨¡æ‹Ÿä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡
        Runnable task = () -> {
            Integer value = transmittableThreadLocalValue.get();
            System.out.println(Thread.currentThread().getName() + " value: " + value); // å­çº¿ç¨‹ç»§æ‰¿äº†ä¸»çº¿ç¨‹çš„å€¼
        };

        // å¯åŠ¨çº¿ç¨‹æ± ä»»åŠ¡
        Thread t1 = new Thread(task);
        Thread t2 = new Thread(task);
        t1.start();
        t2.start();
    }
}
```

**è¾“å‡ºï¼š**

```
Thread-0 value: 10
Thread-1 value: 10
```

- è¿™é‡Œï¼Œ`TransmittableThreadLocal` çš„å€¼ï¼ˆ`10`ï¼‰ä»ä¸»çº¿ç¨‹ä¼ é€’åˆ°å­çº¿ç¨‹ï¼Œå³ä½¿æ˜¯é€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ã€‚

### 3ã€é€‚ç”¨åœºæ™¯

- **è·¨çº¿ç¨‹ä¼ é€’**ï¼šå½“éœ€è¦åœ¨å¼‚æ­¥æ‰§è¡Œï¼ˆä¾‹å¦‚çº¿ç¨‹æ± ï¼‰æˆ–ä»»åŠ¡ä¼ é€’ä¸­ä¿æŒ `ThreadLocal` å€¼æ—¶ã€‚

- **å¢å¼ºçš„çº¿ç¨‹å®‰å…¨**ï¼šç‰¹åˆ«é€‚ç”¨äºéœ€è¦åœ¨å¹¶è¡Œä»»åŠ¡ä¸­ä¼ é€’çˆ¶çº¿ç¨‹ä¸Šä¸‹æ–‡çš„åœºæ™¯ã€‚

### 4ã€å¯¹æ¯” Threadlocal

| ç‰¹æ€§        | **ThreadLocal**        | **TransmittableThreadLocal** |
|-----------|------------------------|------------------------------|
| **çº¿ç¨‹éš”ç¦»**  | æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼Œçº¿ç¨‹ä¹‹é—´äº’ä¸å¹²æ‰°    | æ”¯æŒè·¨çº¿ç¨‹ä¼ é€’ï¼Œé€‚åˆçº¿ç¨‹æ± å’Œå¼‚æ­¥ä»»åŠ¡           |
| **è·¨çº¿ç¨‹ä¼ é€’** | ä¸æ”¯æŒ                    | æ”¯æŒè·¨çº¿ç¨‹ä¼ é€’ï¼ˆå°¤å…¶æ˜¯åœ¨çº¿ç¨‹æ± ä¸­ï¼‰            |
| **é€‚ç”¨åœºæ™¯**  | çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œé¿å…çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡å¼•å‘çš„é—®é¢˜ | è·¨çº¿ç¨‹ä»»åŠ¡ä¼ é€’ï¼Œçº¿ç¨‹æ± å’Œå¼‚æ­¥ä»»åŠ¡çš„ä¸Šä¸‹æ–‡ä¼ é€’       |
| **åº“**     | Java æ ‡å‡†åº“               | é€šå¸¸æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ Alibabaï¼‰æä¾›çš„æ‰©å±•      |

- **`ThreadLocal`** æ›´é€‚åˆ **å•çº¿ç¨‹å†…éƒ¨çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨**ï¼Œé€‚ç”¨äºæ™®é€šçš„å¤šçº¿ç¨‹ç¼–ç¨‹ã€‚

- **`TransmittableThreadLocal`** é€‚åˆäº **éœ€è¦ä¼ é€’ ThreadLocal å€¼çš„å¼‚æ­¥æ“ä½œæˆ–çº¿ç¨‹æ± **ï¼Œè§£å†³äº†ä¼ ç»Ÿ `ThreadLocal`
  åœ¨è·¨çº¿ç¨‹åœºæ™¯ä¸‹ä¸¢å¤±çš„é—®é¢˜ã€‚
