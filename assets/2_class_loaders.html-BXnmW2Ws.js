import{_ as n,c as a,a as l,o as e}from"./app-CXuvinNa.js";const t={};function p(i,s){return e(),a("div",null,s[0]||(s[0]=[l(`<h1 id="类加载器机制" tabindex="-1"><a class="header-anchor" href="#类加载器机制"><span>类加载器机制</span></a></h1><h2 id="启动类加载器-bootstrap" tabindex="-1"><a class="header-anchor" href="#启动类加载器-bootstrap"><span>启动类加载器（Bootstrap）</span></a></h2><ul><li>加载 <code>JAVA_HOME/lib</code> 里的核心类（如 rt.jar、resources.jar）。</li><li>由 C++ 实现，是 JVM 自身的一部分。</li><li>无法通过 Java 代码直接获取（返回 null）。</li><li>加载路径可通过 -Xbootclasspath 指定。</li></ul><h2 id="扩展类加载器-extclassloader" tabindex="-1"><a class="header-anchor" href="#扩展类加载器-extclassloader"><span>扩展类加载器（ExtClassLoader）</span></a></h2><ul><li>加载 <code>JAVA_HOME/lib/ext</code> 目录下的类。</li><li>Java 实现，继承自 URLClassLoader。</li><li>JDK9 之后被平台类加载器（PlatformClassLoader）替代。</li></ul><h2 id="应用类加载器-appclassloader" tabindex="-1"><a class="header-anchor" href="#应用类加载器-appclassloader"><span>应用类加载器（AppClassLoader）</span></a></h2><ul><li>加载 classpath 指定路径下的类。</li><li>也称为系统类加载器（SystemClassLoader）。</li><li>加载用户编写的类和第三方库。</li></ul><h2 id="自定义类加载器" tabindex="-1"><a class="header-anchor" href="#自定义类加载器"><span>自定义类加载器</span></a></h2><ul><li>可实现类隔离、热加载等高级功能。</li><li>继承 ClassLoader 类，重写 findClass 方法。</li><li>常见应用：Tomcat、OSGi、热部署。</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> classPath<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> classPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>classPath <span class="token operator">=</span> classPath<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classData <span class="token operator">=</span> <span class="token function">loadClassData</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">loadClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> path <span class="token operator">=</span> classPath <span class="token operator">+</span> name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.class&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">             <span class="token class-name">ByteArrayOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">int</span> b<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> out<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="类加载过程" tabindex="-1"><a class="header-anchor" href="#类加载过程"><span>类加载过程</span></a></h2><p>包括：加载 → 验证 → 准备 → 解析 → 初始化</p><h3 id="加载-loading" tabindex="-1"><a class="header-anchor" href="#加载-loading"><span>加载（Loading）</span></a></h3><ul><li>读取 .class 文件生成 Class 对象。</li><li>获取类的二进制字节流（文件、网络、动态生成）。</li><li>将字节流转换为方法区的运行时数据结构。</li><li>在堆中生成 Class 对象作为访问入口。</li></ul><h3 id="验证-verification" tabindex="-1"><a class="header-anchor" href="#验证-verification"><span>验证（Verification）</span></a></h3><ul><li>检查字节码合法性，确保加载的类符合 JVM 规范。</li><li>文件格式验证：魔数、版本号、常量池类型等。</li><li>字节码验证：数据类型、操作数栈、局部变量表等。</li><li>符号引用验证：类、字段、方法的引用是否可访问。</li><li>可通过 -Xverify:none 关闭验证（不推荐）。</li></ul><h3 id="准备-preparation" tabindex="-1"><a class="header-anchor" href="#准备-preparation"><span>准备（Preparation）</span></a></h3><ul><li>为静态变量分配内存并初始化默认值。</li><li>只设置默认值（0、null、false），不设置初始值。</li><li>特例：static final 常量在准备阶段直接设置为指定值。</li></ul><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 准备阶段：value = 0</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 准备阶段：CONSTANT = 123</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONSTANT</span> <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="解析-resolution" tabindex="-1"><a class="header-anchor" href="#解析-resolution"><span>解析（Resolution）</span></a></h3><ul><li>将符号引用转换为直接引用。</li><li>符号引用：用字符串描述引用的目标（如 com.example.User）。</li><li>直接引用：指向目标的指针、相对偏移量或句柄。</li><li>包括：类或接口解析、字段解析、方法解析、接口方法解析。</li><li>可通过 -XX:+ClassUnloadingWithConcurrentMark 延迟解析。</li></ul><h3 id="初始化-initialization" tabindex="-1"><a class="header-anchor" href="#初始化-initialization"><span>初始化（Initialization）</span></a></h3><ul><li>执行类构造器 <code>&lt;clinit&gt;</code> 方法。</li><li><code>&lt;clinit&gt;</code> 由编译器自动收集所有类变量的赋值动作和静态语句块。</li><li>父类的 <code>&lt;clinit&gt;</code> 先于子类执行。</li><li>接口的 <code>&lt;clinit&gt;</code> 不需要先执行父接口的 <code>&lt;clinit&gt;</code>。</li><li>初始化触发条件： <ol><li>new、getstatic、putstatic、invokestatic 指令</li><li>反射调用</li><li>初始化子类时先初始化父类</li><li>JVM 启动时的主类</li><li>JDK7 的动态语言支持</li></ol></li></ul><h2 id="类加载器层次结构" tabindex="-1"><a class="header-anchor" href="#类加载器层次结构"><span>类加载器层次结构</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Bootstrap ClassLoader (启动类加载器)</span>
<span class="line">    ↑</span>
<span class="line">Extension ClassLoader (扩展类加载器)</span>
<span class="line">    ↑</span>
<span class="line">Application ClassLoader (应用类加载器)</span>
<span class="line">    ↑</span>
<span class="line">Custom ClassLoader (自定义类加载器)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="类加载器特性" tabindex="-1"><a class="header-anchor" href="#类加载器特性"><span>类加载器特性</span></a></h2><ol><li><strong>双亲委派</strong>：先委托父类加载器加载。</li><li><strong>可见性</strong>：子类加载器可以看到父类加载器加载的类。</li><li><strong>唯一性</strong>：同一个类只加载一次（由同一个类加载器加载）。</li><li><strong>隔离性</strong>：不同类加载器加载的类互不可见。</li></ol>`,27)]))}const o=n(t,[["render",p],["__file","2_class_loaders.html.vue"]]),r=JSON.parse('{"path":"/jvm/2_class_loaders.html","title":"类加载器机制","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"启动类加载器（Bootstrap）","slug":"启动类加载器-bootstrap","link":"#启动类加载器-bootstrap","children":[]},{"level":2,"title":"扩展类加载器（ExtClassLoader）","slug":"扩展类加载器-extclassloader","link":"#扩展类加载器-extclassloader","children":[]},{"level":2,"title":"应用类加载器（AppClassLoader）","slug":"应用类加载器-appclassloader","link":"#应用类加载器-appclassloader","children":[]},{"level":2,"title":"自定义类加载器","slug":"自定义类加载器","link":"#自定义类加载器","children":[]},{"level":2,"title":"类加载过程","slug":"类加载过程","link":"#类加载过程","children":[{"level":3,"title":"加载（Loading）","slug":"加载-loading","link":"#加载-loading","children":[]},{"level":3,"title":"验证（Verification）","slug":"验证-verification","link":"#验证-verification","children":[]},{"level":3,"title":"准备（Preparation）","slug":"准备-preparation","link":"#准备-preparation","children":[]},{"level":3,"title":"解析（Resolution）","slug":"解析-resolution","link":"#解析-resolution","children":[]},{"level":3,"title":"初始化（Initialization）","slug":"初始化-initialization","link":"#初始化-initialization","children":[]}]},{"level":2,"title":"类加载器层次结构","slug":"类加载器层次结构","link":"#类加载器层次结构","children":[]},{"level":2,"title":"类加载器特性","slug":"类加载器特性","link":"#类加载器特性","children":[]}],"git":{"updatedTime":1771046824000,"contributors":[{"name":"hello0709","username":"hello0709","email":"1154937362@qq.com","commits":2,"url":"https://github.com/hello0709"},{"name":"Clarence","username":"Clarence","email":"1154937362@qq.com","commits":1,"url":"https://github.com/Clarence"}]},"filePathRelative":"jvm/2_class_loaders.md"}');export{o as comp,r as data};
